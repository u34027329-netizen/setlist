<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setlist Cloud (Compat)</title>
    <style>
        body { margin: 0; padding: 20px; font-family: sans-serif; background: #222; color: white; text-align: center; }
        #widget-container { width: 300px; margin: 0 auto; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; border: 1px solid #555; }
        ul { list-style: none; padding: 0; }
        li { padding: 10px; margin: 5px 0; background: rgba(255,255,255,0.1); border-radius: 5px; cursor: pointer; }
        li.active { background: #00d1b2; color: black; font-weight: bold; }
        #controls { margin-top: 20px; background: white; padding: 15px; border-radius: 10px; color: black; width: 300px; margin-left: auto; margin-right: auto; }
        input { padding: 10px; width: 60%; }
        button { padding: 10px; cursor: pointer; }
        .add-btn { background: #00d1b2; color: white; border: none; }
        
        /* エラー表示用 */
        #debug-log { color: red; font-size: 12px; margin-top: 10px; background: #ffe6e6; padding: 5px; display: none; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>

    <div id="widget-container">
        <h3>SETLIST</h3>
        <ul id="list"></ul>
    </div>

    <div id="controls">
        <input type="text" id="songInput" placeholder="曲名">
        <button class="add-btn" onclick="addSong()">追加</button>
        <button onclick="clearList()">全消去</button>
        <div id="debug-log"></div> </div>

    <script>
        // --- 設定エリア ---
        const firebaseConfig = {
            apiKey: "AIzaSyBprlYN69O3fMygI-EVG28FxoTXDQnVBog",
            authDomain: "my-setlist-c9b40.firebaseapp.com",
            databaseURL: "https://my-setlist-c9b40-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "my-setlist-c9b40",
            storageBucket: "my-setlist-c9b40.firebasestorage.app",
            messagingSenderId: "917897337856",
            appId: "1:917897337856:web:b776d59cd602cf0d298ce5"
        };

        // --- プログラム本体 ---
        let db;
        const logBox = document.getElementById('debug-log');

        function showLog(msg) {
            logBox.style.display = 'block';
            logBox.innerText = "状態: " + msg;
        }

        try {
            // Firebaseの開始
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            showLog("準備OK！追加ボタンを押してみてね");

            // データの監視（受信）
            db.ref('setlist').on('value', (snapshot) => {
                const listEl = document.getElementById('list');
                listEl.innerHTML = ''; // リセット
                
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const data = child.val();
                        const li = document.createElement('li');
                        li.textContent = data.title;
                        if (data.active) li.classList.add('active');
                        
                        // クリック機能
                        li.onclick = () => {
                            // 一度全オフにしてからオン
                            db.ref('setlist').once('value', s => {
                                const updates = {};
                                s.forEach(c => updates[c.key + '/active'] = (c.key === child.key));
                                db.ref('setlist').update(updates);
                            });
                        };
                        
                        // 削除機能(右クリック)
                        li.oncontextmenu = (e) => {
                            e.preventDefault();
                            db.ref('setlist/' + child.key).remove();
                        };
                        
                        listEl.appendChild(li);
                    });
                }
            }, (error) => {
                showLog("受信エラー: " + error.message);
            });

        } catch (e) {
            showLog("起動エラー: " + e.message);
        }

        // 追加機能
        window.addSong = function() {
            const input = document.getElementById('songInput');
            if (!input.value) return;

            showLog("送信中...");
            db.ref('setlist').push({
                title: input.value,
                active: false
            }).then(() => {
                showLog("追加成功！");
                input.value = '';
            }).catch((error) => {
                showLog("失敗: " + error.code);
                alert("送信失敗！Firebaseのルール設定を確認してください");
            });
        };

        // 消去機能
        window.clearList = function() {
            if(confirm("本当に消しますか？")) {
                db.ref('setlist').remove();
            }
        };
    </script>
</body>
</html>
