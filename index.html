<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setlist Cloud - Fix Version</title>
    <style>
        :root { --accent: #00d1b2; --bg: rgba(0, 0, 0, 0.8); }
        body { margin: 0; padding: 20px; font-family: sans-serif; background: #333; color: white; display: flex; flex-direction: column; align-items: center; }
        #widget-container { width: 320px; background: var(--bg); border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { margin: 0 0 15px 0; font-size: 14px; text-align: center; border-bottom: 1px solid #444; padding-bottom: 10px; }
        ul { list-style: none; padding: 0; margin: 0; }
        li { padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; }
        li.active { background: var(--accent); color: #000; font-weight: bold; }
        #controls { margin-top: 20px; width: 320px; background: white; padding: 20px; border-radius: 15px; color: #333; }
        input { width: 100%; padding: 12px; box-sizing: border-box; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px; font-size: 16px; }
        .btn-group { display: flex; gap: 8px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .add-btn { background: var(--accent); color: white; }
        .clear-btn { background: #ff4757; color: white; }
        #status-msg { font-size: 11px; text-align: center; margin-top: 5px; color: #ff4757; }
        [data-mode="obs"] #controls { display: none; }
    </style>
</head>
<body>

<div id="widget-container">
    <h2>SETLIST</h2>
    <ul id="list"></ul>
</div>

<div id="controls">
    <input type="text" id="songInput" placeholder="曲名を入力">
    <div class="btn-group">
        <button class="add-btn" id="addBtn">追加</button>
        <button class="clear-btn" id="clearBtn">全消去</button>
    </div>
    <div id="status-msg"></div>
</div>

<script type="module">
    // 安定性の高いライブラリ読み込み
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBprlYN69O3fMygI-EVG28FxoTXDQnVBog",
        authDomain: "my-setlist-c9b40.firebaseapp.com",
        databaseURL: "https://my-setlist-c9b40-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "my-setlist-c9b40",
        storageBucket: "my-setlist-c9b40.firebasestorage.app",
        messagingSenderId: "917897337856",
        appId: "1:917897337856:web:b776d59cd602cf0d298ce5"
    };

    try {
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const listRef = ref(db, 'setlist');
        const status = document.getElementById('status-msg');

        if (new URLSearchParams(window.location.search).get('obs')) {
            document.body.setAttribute('data-mode', 'obs');
        }

        // 追加ボタンの動作
        document.getElementById('addBtn').onclick = async () => {
            const val = document.getElementById('songInput').value;
            if (!val) return;
            status.innerText = "送信中...";
            try {
                await push(listRef, { title: val, active: false });
                document.getElementById('songInput').value = '';
                status.innerText = "";
            } catch (e) {
                status.innerText = "エラー: ルール設定を確認してください";
                console.error(e);
            }
        };

        // データ表示の同期
        onValue(listRef, (snapshot) => {
            const listElement = document.getElementById('list');
            listElement.innerHTML = '';
            snapshot.forEach((child) => {
                const data = child.val();
                const li = document.createElement('li');
                li.textContent = data.title;
                if (data.active) li.classList.add('active');
                li.onclick = () => {
                    const updates = {};
                    snapshot.forEach(c => { updates[c.key + '/active'] = (c.key === child.key); });
                    update(listRef, updates);
                };
                li.oncontextmenu = (e) => { e.preventDefault(); remove(ref(db, 'setlist/' + child.key)); };
                listElement.appendChild(li);
            });
        }, (error) => {
            status.innerText = "接続失敗：Firebaseの「ルール」を確認！";
        });

        document.getElementById('clearBtn').onclick = () => { if(confirm("消去？")) remove(listRef); };

    } catch (e) {
        document.getElementById('status-msg').innerText = "初期化失敗：設定を確認してください";
    }
</script>
</body>
</html>
